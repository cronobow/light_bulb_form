<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡ˆæ³¡è¡¨å–® - é™¤éŒ¯å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        h1 {
            color: #ffff00;
            margin-bottom: 20px;
            border-bottom: 2px solid #ffff00;
            padding-bottom: 10px;
        }

        h2 {
            color: #00ffff;
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .section {
            background: #2d2d2d;
            border: 1px solid #00ff00;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .config {
            background: #3a3a3a;
            padding: 15px;
            border-left: 4px solid #00ffff;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .config label {
            display: block;
            margin-bottom: 10px;
            color: #00ffff;
        }

        .config input {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }

        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #00dd00;
        }

        button.success {
            background: #00ff00;
        }

        button.warning {
            background: #ffff00;
            color: #000;
        }

        button.error {
            background: #ff0000;
            color: #fff;
        }

        .log-output {
            background: #1e1e1e;
            border: 1px solid #00ff00;
            border-radius: 4px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 13px;
        }

        .log-line {
            margin-bottom: 5px;
            padding: 3px 5px;
        }

        .log-time {
            color: #888888;
        }

        .log-success {
            color: #00ff00;
        }

        .log-error {
            color: #ff6666;
        }

        .log-warning {
            color: #ffff00;
        }

        .log-info {
            color: #00ffff;
        }

        .log-data {
            color: #ffcc00;
        }

        .instructions {
            background: #3a5a3a;
            border-left: 4px solid #00ff00;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .instructions h3 {
            color: #00ff00;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .status.connected {
            background: #003300;
            border-left: 4px solid #00ff00;
            color: #00ff00;
        }

        .status.disconnected {
            background: #330000;
            border-left: 4px solid #ff0000;
            color: #ff6666;
        }

        .status.unknown {
            background: #333300;
            border-left: 4px solid #ffff00;
            color: #ffff00;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            background: #1e1e1e;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .test-result {
            background: #2d2d2d;
            border-left: 4px solid #00ffff;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        code {
            background: #1e1e1e;
            padding: 2px 5px;
            border-radius: 3px;
            border: 1px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ç‡ˆæ³¡è¡¨å–®ç³»çµ± - é™¤éŒ¯å·¥å…·</h1>

        <div class="instructions">
            <h3>ğŸ“– å¦‚ä½•æŸ¥çœ‹ Google Apps Script çš„åŸ·è¡Œæ—¥èªŒ</h3>
            <ol>
                <li><strong>é¦–å…ˆï¼Œç²å–ä½ çš„ Web App URLï¼ˆé‡è¦ï¼ï¼‰</strong>
                    <ul>
                        <li>æ‰“é–‹ä½ çš„ Google Sheets</li>
                        <li>é»é¸ã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€</li>
                        <li>é»é¸ã€Œéƒ¨ç½²ã€â†’ã€Œç®¡ç†éƒ¨ç½²ä½œæ¥­ã€</li>
                        <li>è¤‡è£½ã€ŒURLã€æ¬„ä½çš„å®Œæ•´é€£çµï¼ˆä»¥ <code>/exec</code> çµå°¾ï¼‰</li>
                        <li>è²¼åˆ°ä¸‹æ–¹ã€Œè¨­å®š Web App URLã€å€åŸŸ</li>
                    </ul>
                </li>
                <li><strong>æ–¹æ³• 1ï¼šç›´æ¥åœ¨ Google Apps Script ç·¨è¼¯å™¨æŸ¥çœ‹</strong>
                    <ul>
                        <li>é–‹å•Ÿä½ çš„ Google Apps Script ç·¨è¼¯å™¨</li>
                        <li>é»é¸å·¦ä¸‹è§’çš„ã€ŒåŸ·è¡Œè¨˜éŒ„ã€åœ–ç¤º ğŸ“‹</li>
                        <li>é¸æ“‡æœ€æ–°çš„åŸ·è¡Œè¨˜éŒ„</li>
                        <li>æŸ¥çœ‹è©³ç´°çš„ Logger.log è¼¸å‡º</li>
                    </ul>
                </li>
                <li><strong>æ–¹æ³• 2ï¼šä½¿ç”¨ä¸‹æ–¹çš„æ¸¬è©¦å·¥å…·</strong>
                    <ul>
                        <li>åœ¨ä¸‹æ–¹è¼¸å…¥ä½ çš„ Google Apps Script Web App URL</li>
                        <li>é»é¸ã€Œç™¼é€æ¸¬è©¦è«‹æ±‚ã€</li>
                        <li>æŸ¥çœ‹å›æ‡‰å’Œæ—¥èªŒ</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="section">
            <h2>ğŸ”Œ é€£ç·šç‹€æ…‹æª¢æŸ¥</h2>
            <button onclick="testConnection()">æª¢æŸ¥é€£ç·š</button>
            <div id="statusDiv" style="margin-top: 15px;"></div>
        </div>

        <div class="section">
            <h2>âš™ï¸ è¨­å®š Web App URL</h2>
            <div class="config">
                <label>Google Apps Script Web App URL:</label>
                <input type="text" id="webAppUrl" placeholder="https://script.google.com/macros/s/AKfycbz...../usercontent" 
                       value="">
                <button onclick="saveUrl()">ä¿å­˜ URL</button>
                <button onclick="clearUrl()" class="warning">æ¸…é™¤</button>
            </div>
        </div>

        <div class="section">
            <h2>âœ‰ï¸ ç™¼é€æ¸¬è©¦è³‡æ–™</h2>
            <div>
                <label>æ¸¬è©¦è³‡æ–™ (JSON):</label>
                <textarea id="testData" placeholder="è¼¸å…¥è¦ç™¼é€çš„æ¸¬è©¦è³‡æ–™"></textarea>
                <button onclick="loadSampleData()">è¼‰å…¥ç¯„ä¾‹è³‡æ–™</button>
                <button onclick="sendTestData()" class="success">ç™¼é€æ¸¬è©¦è«‹æ±‚</button>
            </div>
        </div>

        <div class="section">
            <h2>ğŸ“Š æ¸¬è©¦çµæœ</h2>
            <div id="testResultDiv" style="color: #999;">ç­‰å¾…æ¸¬è©¦...</div>
        </div>

        <div class="section">
            <h2>ğŸ“‹ å‰ç«¯é é¢è³‡è¨Š</h2>
            <button onclick="checkFrontendConfig()">æª¢æŸ¥å‰ç«¯è¨­å®š</button>
            <div id="frontendInfoDiv" style="margin-top: 15px;"></div>
        </div>

        <div class="section">
            <h2>ğŸ› ï¸ å¿«é€Ÿè¨ºæ–·</h2>
            <button onclick="runFullDiagnostics()" class="warning">åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
            <div id="diagnosticsDiv" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        // è¼‰å…¥ä¿å­˜çš„ URL
        function loadSavedUrl() {
            const saved = localStorage.getItem('webAppUrl');
            if (saved) {
                document.getElementById('webAppUrl').value = saved;
            }
        }

        // ä¿å­˜ URL
        function saveUrl() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (!url) {
                alert('è«‹è¼¸å…¥ Web App URL');
                return;
            }
            localStorage.setItem('webAppUrl', url);
            addLog('âœ“ URL å·²ä¿å­˜', 'success');
        }

        // æ¸…é™¤ URL
        function clearUrl() {
            localStorage.removeItem('webAppUrl');
            document.getElementById('webAppUrl').value = '';
            addLog('âœ“ URL å·²æ¸…é™¤', 'warning');
        }

        // ç²å– Web App URL
        function getWebAppUrl() {
            const url = document.getElementById('webAppUrl').value.trim();
            if (!url) {
                alert('è«‹å…ˆè¼¸å…¥ Web App URL');
                return null;
            }
            return url;
        }

        // è¼‰å…¥ç¯„ä¾‹è³‡æ–™
        function loadSampleData() {
            const sampleData = {
                "timestamp": new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }),
                "requester": "ç¸½å¹¹äº‹",
                "bulbType": "ä¸€èˆ¬ç‡ˆ",
                "locations": [
                    {
                        "category": "å…¬å…±å€åŸŸ",
                        "location": "è­¦è¡›å®¤å‚™ç”¨",
                        "quantity": 5
                    },
                    {
                        "category": "Aæ£Ÿ",
                        "location": "Aæ£Ÿ1æ¨“",
                        "quantity": 3
                    }
                ],
                "totalQuantity": 8
            };
            document.getElementById('testData').value = JSON.stringify(sampleData, null, 2);
            addLog('âœ“ ç¯„ä¾‹è³‡æ–™å·²è¼‰å…¥', 'info');
        }

        // ç™¼é€æ¸¬è©¦è«‹æ±‚
        async function sendTestData() {
            const url = getWebAppUrl();
            if (!url) return;

            const dataText = document.getElementById('testData').value.trim();
            if (!dataText) {
                alert('è«‹è¼¸å…¥æ¸¬è©¦è³‡æ–™');
                return;
            }

            try {
                addLog('æ­£åœ¨ç™¼é€æ¸¬è©¦è«‹æ±‚...', 'info');
                addLog('URL: ' + url, 'data');

                let data;
                try {
                    data = JSON.parse(dataText);
                } catch (e) {
                    addLog('âŒ JSON æ ¼å¼éŒ¯èª¤: ' + e.message, 'error');
                    return;
                }

                addLog('ç™¼é€è³‡æ–™: ' + JSON.stringify(data, null, 2), 'data');

                const response = await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                addLog('âœ“ è«‹æ±‚å·²ç™¼é€', 'success');
                addLog('å›æ‡‰ç‹€æ…‹: ' + response.status, 'info');
                addLog('â³ è³‡æ–™å·²æäº¤åˆ°å¾Œç«¯ã€‚è«‹åœ¨ Google Apps Script ç·¨è¼¯å™¨æŸ¥çœ‹åŸ·è¡Œè¨˜éŒ„ï¼', 'warning');

                // å˜—è©¦è®€å–å›æ‡‰
                try {
                    const responseText = await response.text();
                    if (responseText) {
                        addLog('å¾Œç«¯å›æ‡‰: ' + responseText, 'data');
                    }
                } catch (e) {
                    addLog('ï¼ˆå› ç‚ºä½¿ç”¨ no-cors æ¨¡å¼ï¼Œç„¡æ³•è®€å–å›æ‡‰å…§å®¹ï¼‰', 'info');
                }

            } catch (error) {
                addLog('âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
                addLog('éŒ¯èª¤å †ç–Š: ' + error.stack, 'error');
            }
        }

        // æª¢æŸ¥é€£ç·š
        async function testConnection() {
            const url = getWebAppUrl();
            if (!url) return;

            try {
                addLog('æ­£åœ¨æª¢æŸ¥é€£ç·š...', 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'no-cors'
                });

                addLog('âœ“ é€£ç·šæˆåŠŸï¼', 'success');
                updateStatus('é€£ç·šæ­£å¸¸', 'connected');

            } catch (error) {
                addLog('âŒ é€£ç·šå¤±æ•—: ' + error.message, 'error');
                updateStatus('é€£ç·šå¤±æ•—', 'disconnected');
            }
        }

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        function updateStatus(message, status) {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${status}">${message}</div>`;
        }

        // æª¢æŸ¥å‰ç«¯è¨­å®š
        function checkFrontendConfig() {
            const div = document.getElementById('frontendInfoDiv');
            let html = '<div class="log-output">';

            // æª¢æŸ¥ script.js ä¸­çš„è¨­å®š
            try {
                // å˜—è©¦å¾ HTML é é¢çš„ script æ¨™ç±¤å–å¾— GOOGLE_SHEET_URL
                let frontendUrl = null;
                
                // æ–¹æ³• 1: ç›´æ¥æª¢æŸ¥å…¨å±€è®Šæ•¸
                if (typeof GOOGLE_SHEET_URL !== 'undefined') {
                    frontendUrl = GOOGLE_SHEET_URL;
                }
                
                // æ–¹æ³• 2: å¦‚æœåœ¨ debug.html ä¸­ç„¡æ³•å­˜å–ï¼Œå¾æœ¬åœ°å­˜å„²è®€å–
                if (!frontendUrl) {
                    const savedUrl = localStorage.getItem('webAppUrl');
                    if (savedUrl) {
                        frontendUrl = savedUrl;
                        html += '<div class="log-line"><span class="log-info">ğŸ’¡ å¾æœ¬åœ°å„²å­˜è®€å– URL</span></div>';
                    }
                }
                
                if (frontendUrl) {
                    const isConfigured = frontendUrl !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';
                    const status = isConfigured ? 'âœ“ å·²è¨­å®š' : 'âŒ æœªè¨­å®š';
                    const color = isConfigured ? 'log-success' : 'log-error';
                    html += `<div class="log-line"><span class="${color}">${status}</span> - å‰ç«¯ Web App URL</div>`;
                    html += `<div class="log-line"><span class="log-data">URL: ${frontendUrl}</span></div>`;
                } else {
                    html += '<div class="log-line"><span class="log-warning">âš ï¸ æ‰¾ä¸åˆ° GOOGLE_SHEET_URL è®Šæ•¸</span></div>';
                    html += '<div class="log-line"><span class="log-info">ğŸ’¡ å»ºè­°ï¼šåœ¨ debug.html çš„ã€Œè¨­å®š Web App URLã€æ‰‹å‹•è¼¸å…¥ä½ çš„ URL</span></div>';
                }
            } catch (e) {
                html += `<div class="log-line"><span class="log-error">âŒ æª¢æŸ¥å¤±æ•—: ${e.message}</span></div>`;
            }

            // æª¢æŸ¥æœ¬åœ°å­˜å„²
            const savedUrl = localStorage.getItem('webAppUrl');
            html += `<div class="log-line"><span class="log-info">ğŸ’¾ æœ¬åœ°å„²å­˜ URL:</span> ${savedUrl ? savedUrl : 'æœªè¨­å®š'}</div>`;

            // æª¢æŸ¥ç€è¦½å™¨è³‡è¨Š
            html += `<div class="log-line"><span class="log-info">ğŸŒ ç€è¦½å™¨:</span> ${navigator.userAgent.substring(0, 50)}...</div>`;

            html += '</div>';
            div.innerHTML = html;
        }

        // åŸ·è¡Œå®Œæ•´è¨ºæ–·
        async function runFullDiagnostics() {
            const div = document.getElementById('diagnosticsDiv');
            let html = '<div class="log-output">';

            html += '<div class="log-line"><span class="log-info">â–¶ æ­£åœ¨åŸ·è¡Œå®Œæ•´è¨ºæ–·...</span></div>';

            // 1. æª¢æŸ¥ Web App URL
            const url = localStorage.getItem('webAppUrl');
            if (!url) {
                html += '<div class="log-line"><span class="log-error">âŒ Web App URL æœªè¨­å®š</span></div>';
            } else {
                html += `<div class="log-line"><span class="log-success">âœ“ Web App URL:</span> ${url}</div>`;
            }

            // 2. æª¢æŸ¥å‰ç«¯è¨­å®š
            if (typeof GOOGLE_SHEET_URL !== 'undefined') {
                const isConfigured = GOOGLE_SHEET_URL !== 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';
                html += `<div class="log-line"><span class="log-info">å‰ç«¯è¨­å®š:</span> ${isConfigured ? '<span class="log-success">âœ“ å·²è¨­å®š</span>' : '<span class="log-error">âŒ æœªè¨­å®š</span>'}</span></div>`;
            }

            // 3. æ¸¬è©¦é€£ç·š
            if (url) {
                try {
                    const response = await fetch(url, { method: 'GET', mode: 'no-cors' });
                    html += '<div class="log-line"><span class="log-success">âœ“ é€£ç·šæ­£å¸¸</span></div>';
                } catch (e) {
                    html += `<div class="log-line"><span class="log-error">âŒ é€£ç·šå¤±æ•—: ${e.message}</span></div>`;
                }
            }

            // 4. å»ºè­°
            html += '<div class="log-line"><span class="log-warning">ğŸ’¡ å»ºè­°æ­¥é©Ÿï¼š</span></div>';
            html += '<div class="log-line" style="margin-left: 20px;">1. ç¢ºèª Web App URL å·²æ­£ç¢ºè¨­å®š</div>';
            html += '<div class="log-line" style="margin-left: 20px;">2. åœ¨è¡¨å–®é é¢æ‰“é–‹ Console (F12) å¡«å¯«ä¸¦æäº¤è¡¨å–®</div>';
            html += '<div class="log-line" style="margin-left: 20px;">3. æŸ¥çœ‹ Console ä¸­çš„æäº¤æ—¥èªŒ</div>';
            html += '<div class="log-line" style="margin-left: 20px;">4. é–‹å•Ÿ Google Apps Script ç·¨è¼¯å™¨ï¼Œé»é¸ã€ŒåŸ·è¡Œè¨˜éŒ„ã€æŸ¥çœ‹å¾Œç«¯æ—¥èªŒ</div>';
            html += '<div class="log-line" style="margin-left: 20px;">5. æª¢æŸ¥ Google Sheets æ˜¯å¦æœ‰æ–°è³‡æ–™</div>';

            html += '</div>';
            div.innerHTML = html;
        }

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            const resultDiv = document.getElementById('testResultDiv');
            const time = new Date().toLocaleTimeString('zh-TW');
            const logClass = `log-${type}`;
            const logLine = `<div class="log-line"><span class="log-time">[${time}]</span> <span class="${logClass}">${message}</span></div>`;
            resultDiv.innerHTML = logLine + resultDiv.innerHTML;
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('load', () => {
            loadSavedUrl();
            addLog('é™¤éŒ¯å·¥å…·å·²è¼‰å…¥', 'info');
        });
    </script>
</body>
</html>
