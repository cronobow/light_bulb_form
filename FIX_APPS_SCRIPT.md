# 🔧 Google Apps Script 執行記錄修復指南

## ⚠️ 問題說明

執行記錄中沒有資料，可能的原因：
1. Apps Script 沒有正確授權
2. 舊的部署仍在使用
3. 需要重新部署新版本

---

## ✅ 修復步驟

### 步驟 1：更新 Code.gs

已經為你更新了 `Code.gs` 文件，新增了：
- ✅ `testWrite()` 函數：用於本地測試
- ✅ 改進的錯誤處理
- ✅ 更詳細的 Logger 日誌

### 步驟 2：複製新的 Code.gs 內容

1. **打開 `Code.gs` 文件**
   ```
   路徑：/Users/max/maxlab/forms/Code.gs
   ```

2. **複製整個文件內容**
   - 選擇全部（Ctrl+A 或 Cmd+A）
   - 複製（Ctrl+C 或 Cmd+C）

### 步驟 3：貼到 Google Apps Script 編輯器

1. **打開 Google Sheets**
2. **點選「擴充功能」→「Apps Script」**
3. **刪除編輯器中的所有代碼**
4. **貼上新的 Code.gs 內容**
5. **按 Ctrl+S 或 Cmd+S 保存**

### 步驟 4：授權 Apps Script

Google 會要求你授予權限：
1. 點選「需要授權」
2. 選擇你的 Google 帳號
3. 點選「允許」
4. 完成授權流程

### 步驟 5：測試寫入功能

1. **在編輯器中，頂部選擇函數下拉選單**
2. **選擇 `testWrite` 函數**
3. **點選執行按鈕（▶）**
4. **查看執行記錄：**
   - 應該看到「✓ 測試資料已寫入」
   - 檢查 Google Sheets 中是否有新的工作表「燈泡使用登記表」
   - 檢查是否有測試資料

**如果測試成功：** ✓ 代表 Apps Script 工作正常，進行步驟 6

**如果測試失敗：** ❌ 查看執行記錄中的錯誤訊息

### 步驟 6：重新部署

1. **點選「部署」→「管理部署作業」**
2. **如果有舊的部署，點擊舊部署右邊的「⋮」（三個點）**
3. **選擇「刪除」並確認**
4. **點選「新增部署作業」**
5. **選擇類型：「網頁應用程式」**
6. **設定：**
   - 執行身分：「我」
   - 存取權：「所有人」
7. **點選「部署」**
8. **複製新的 URL**（很重要！）

### 步驟 7：更新前端 URL

1. **打開 `script.js`**
2. **找到第 2 行**
3. **更新 `GOOGLE_SHEET_URL`：**
   ```javascript
   const GOOGLE_SHEET_URL = '你新複製的URL';
   ```
4. **保存文件**

### 步驟 8：測試表單提交

1. **打開 `index.html`**
2. **按 F12 開啟開發者工具**
3. **切換到 Console 頁籤**
4. **填寫表單並提交**
5. **查看 Console 日誌，應該看到：**
   ```
   ========== 開始提交表單 ==========
   領用人: 總幹事
   ...
   ✓ 請求已發送
   ========== 提交完成 ==========
   ```

### 步驟 9：檢查 Google Sheets

1. **打開你的 Google Sheets**
2. **查看「燈泡使用登記表」工作表**
3. **應該看到新提交的資料**

---

## 🔍 故障排除

### 問題 1：testWrite 執行失敗

**症狀：** 執行 testWrite 時出現錯誤

**解決方案：**
1. 檢查是否完成了授權
2. 查看執行記錄中的具體錯誤訊息
3. 確認試算表有編輯權限

### 問題 2：部署後仍無法提交

**症狀：** 執行記錄仍然空白

**解決方案：**
1. 確認 script.js 中的 URL 已更新
2. 清除瀏覽器快取（Ctrl+Shift+Delete）
3. 重新整理頁面（Ctrl+F5）
4. 重新提交表單

### 問題 3：doPost 函數未被執行

**症狀：** 前端顯示提交成功，但執行記錄中沒有日誌

**可能原因：**
- 使用 no-cors 模式時，Google Apps Script 可能沒收到請求
- Web App URL 可能不正確
- 部署可能未完成

**解決方案：**
1. 重新完整部署（刪除舊部署 → 新增部署）
2. 確認 Web App URL 完全正確
3. 使用 debug.html 測試連線

### 問題 4：收到 JSON 解析錯誤

**症狀：** 執行記錄顯示「JSON 解析失敗」

**解決方案：**
1. 檢查前端是否正確發送 JSON
2. 查看執行記錄中的「原始資料」
3. 檢查資料格式是否正確

---

## 📋 快速檢查清單

按順序執行：

- [ ] 在 Google Apps Script 編輯器中複製新的 Code.gs
- [ ] 保存 Code.gs
- [ ] 授權 Apps Script
- [ ] 執行 testWrite 函數進行測試
- [ ] 檢查 Google Sheets 是否有測試資料
- [ ] 重新部署（刪除舊的 → 新增新的）
- [ ] 複製新的 Web App URL
- [ ] 更新 script.js 中的 URL
- [ ] 清除瀏覽器快取（Ctrl+Shift+Delete）
- [ ] 打開 index.html 重新整理
- [ ] 填寫表單並提交
- [ ] 檢查 Console 是否有成功日誌
- [ ] 檢查 Google Sheets 是否有新資料
- [ ] 檢查 Google Apps Script 執行記錄確認

---

## 💡 提示

如果仍有問題，請：

1. **收集以下資訊：**
   - Google Apps Script 執行記錄的完整錯誤訊息
   - 前端 Console 的完整日誌
   - 你的 Web App URL

2. **檢查 Google Sheets 工作表名稱：**
   - 應該是「燈泡使用登記表」
   - 名稱必須完全匹配

3. **驗證 Apps Script 部署：**
   - 確認執行身分為「我」
   - 確認存取權為「所有人」
   - 確認狀態為「已部署」

---

祝修復順利！🚀
